%\documentclass[dvipdfmx]{beamer}
\documentclass[unicode]{beamer}                   % lualatex の場合
\usepackage{mySld}

\begin{document}
\title[CPUの仮想化]{オペレーティングシステム\\第３章 CPUの仮想化}
\date{}
\begin{frame}
  \titlepage
  \centerline{\url{https://github.com/tctsigemura/OSTextBook}}
\end{frame}

%=========================================================================
%\begin{frame}
%  \frametitle
%  \tableofcontents
%\end{frame}

%=========================================================================
\section{時分割多重}
\begin{frame}
  \frametitle{時分割多重によるCPUの仮想化}
  \fig{scale=0.7}{virtualCPU-crop.pdf}
  \begin{itemize}
    \item 時分割多重：CPUが実行するプロセスを次々切換える。
    \item ディスパッチ：プロセスにCPUを割り付ける。（実行開始）
    \item ディスパッチャ：ディスパッチするプログラムのこと。
  \end{itemize}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{CPUの構造（参考）}
  \fig{scale=0.6}{cpuBlock-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{プロセスの構造（参考）}
  \fig{scale=0.5}{procOrganization-crop.pdf}
\end{frame}

%=========================================================================
\section{プロセスの状態}
\begin{frame}
  \frametitle{プロセスの状態遷移}
  \fig{scale=0.6}{procState-crop.pdf}
  \begin{itemize}
    \item 基本的な三つの状態
    \item 六つの状態遷移
  \end{itemize}
\end{frame}

%=========================================================================
\section{プロセスの切換え}
\begin{frame}
  \frametitle{プロセスの切換え}
  \fig{scale=0.38}{procSwitch-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{オペレーティングシステムの構造（参考）}
  \fig{scale=0.4}{osOrganization-crop.pdf}
  \begin{itemize}
    \item 割込みハンドラ
    \item サービスモジュール
    \item ディスパッチャ
  \end{itemize}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{プロセスの切換えの例}
  \fig{scale=0.34}{procSwitchInst-crop.pdf}
\end{frame}

%=========================================================================
\section{PCB（Process Control Block）}
\begin{frame}
  \frametitle{PCBの内容}
\begin{itemize}
\item 仮想CPU
\item プロセス番号
\item 状態（Running，Waiting，Ready等）
\item 優先度
\item 統計情報（CPU利用時間等）
\item 次回のアラーム時刻
\item 親プロセス
\item 子プロセス一覧
\item シグナルハンドリング
\item 使用中のメモリ
\item オープン中のファイル
\item カレントディレクトリ
\item プロセス所有者のユーザ番号
\item PCBのリストを作るためのポインタ
\end{itemize}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{PCBのリスト}
  \fig{scale=0.4}{procQueue-crop.pdf}
\end{frame}

%=========================================================================
\section{TacOSのCPU仮想化}
\begin{frame}
  \frametitle{TacOSのPCB}
  \begin{itemize}
    \item 仮想CPU（SP）
    \item プロセス番号（pid）
    \item 状態(stat）
    \item 優先度（nice, enice）
    \item プロセステーブルのインデクス（idx）
    \item イベント用カウンタとセマフォ(evtCnt，evtSem）
    \item プロセスのアドレス空間（memBase，memLen）
    \item プロセスの親子関係の情報（parent，exitStat）
    \item オープン中のファイル一覧（fds[]）
    \item PCBリストの管理（prev，next）
    \item スタックオーバーフローの検知（magic）
  \end{itemize}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{TacOSのPCB（前半）}
  \src{firstline=56,lastline=67,frame=tlr,xleftmargin=5mm}{kernel/process.hmm}
  \vspace{-5mm}\src{firstline=68,lastline=76,frame=lr,
  numbers=left,xleftmargin=5mm,firstnumber=1}{kernel/process.hmm}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{TacOSのPCB（後半）}
  \src{firstline=77,lastline=96,frame=lrb,
  numbers=left,xleftmargin=5mm,firstnumber=10}{kernel/process.hmm}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{TacOSの実行可能列}
  \begin{itemize}
    \item {\tt yield}
    \item {\tt dispatch}
    \item 実行可能列
      \fig{scale=0.5}{tacosReadyQueue-crop.pdf}
  \end{itemize}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{TacOSのメモリ配置}
  \fig{scale=0.4}{tacosMemMap-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{TacOSのタイマー管理プログラム}
  \src{firstline=465,lastline=483,
  numbers=left,xleftmargin=5mm,firstnumber=3}{kernel/kernel.cmm}
\end{frame}

%=========================================================================
\begin{frame}[fragile]
  \frametitle{TacOSのコンテキスト保存プログラム（yield()）}
  \src{firstline=49,lastline=56,frame=tlr,
  numbers=left,xleftmargin=5mm,firstnumber=1}{kernel/dispatcher.s}
  \vspace{-5mm}\begin{lstlisting}[frame=lr,xleftmargin=5mm]

        ...
  \end{lstlisting}
  \vspace{-5mm}\src{firstline=65,lastline=77,frame=lr,
  numbers=left,xleftmargin=5mm,firstnumber=17}{kernel/dispatcher.s}
\end{frame}

%=========================================================================
\begin{frame}[fragile]
  \frametitle{TacOSのコンテスト復旧プログラム（dispatch()）}
  \src{firstline=78,lastline=90,frame=lr,
    numbers=left,xleftmargin=5mm,firstnumber=1}{kernel/dispatcher.s}
  \vspace{-5mm}\begin{lstlisting}[frame=lr,xleftmargin=5mm]

        ...
  \end{lstlisting}
  \vspace{-5mm}\src{firstline=98,lastline=102,frame=lrb,
    numbers=left,xleftmargin=5mm,firstnumber=21}{kernel/dispatcher.s}
\end{frame}

%=========================================================================
\section{スレッド（Thread）}
\begin{frame}
  \frametitle{マルチプログラミングを用いないWebサーバ}
  \fig{scale=0.6}{singleProcSingleClient-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{マルチプログラミングを用いないWebサーバ}
  \fig{scale=0.6}{singleProcMultiClient-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{マルチプログラミングを用いるWebサーバ}
  \fig{scale=0.6}{multiProc-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{マルチプログラミングを用いるWebサーバ}
  \fig{scale=0.6}{multiThread-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{ユーザスレッドとカーネルスレッド}
  \fig{scale=0.5}{kernelThread-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{ユーザスレッドとカーネルスレッド}
  \fig{scale=0.5}{userThread-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}
  \frametitle{M個のスレッドで手分けをして合計を計算する様子}
  \fig{scale=0.6}{threadedSum-crop.pdf}
\end{frame}

%=========================================================================
\begin{frame}[fragile]
  \frametitle{M個のスレッドで合計を計算する（前半）}
  \smp{language={C},lastline=21,frame=tlr,
    numbers=left,xleftmargin=5mm,firstnumber=1}{pThread/threadTest.c}
\end{frame}

%=========================================================================
\begin{frame}[fragile]
  \frametitle{M個のスレッドで合計を計算する（後半）}
  \smp{language={C},firstline=22,frame=lrb,
    numbers=left,xleftmargin=5mm,firstnumber=22}{pThread/threadTest.c}
\end{frame}

%=========================================================================
\begin{frame}[fragile]
  \frametitle{M個のスレッドで合計を計算する（後半）}
  \tbl{scale=0.7}{threadTimeTbl.pdf}
  \tbl{scale=0.8}{threadTimeGrph.pdf}
  ６コアのMac Proで計測\\
  （Hyper-Threadingのお陰で６コアと１２コアの中間的な振舞）
\end{frame}

\end{document}
