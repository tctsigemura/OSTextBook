\chapter{二次記憶装置（ストレージ）}
容量が小さく揮発性の主記憶だけでは
コンピュータを実用的に使用することができない．
二次記憶装置をプログラムやデータを格納したファイルの
永続的な置き場として使用する．
ファイルを永続的に記憶するためには，
大容量で不揮発性の二次記憶装置が適している．

%==============================================================================
\section{記憶装置の階層}
現代のコンピュータは，様々な種類の記憶装置を使用している．
\figref{memoryHierachy}にコンピュータの記憶装置の関係を簡単に示す．
図では，上の層にあるものほど高価で高速なメモリである．

\begin{enumerate}
\item \emph{レジスタ}はCPUレジスタのことを表す．
  CPUレジスタは容量が小さい\footnote{多くのCPUでは数十バイト程度である．}が
  高速にアクセスすることが可能な記憶装置である．
\item \emph{主記憶（メモリ）}は数ナノ秒〜十数ナノ秒程度の
  時間でアクセスできる高速な記憶装置である．
  コンピュータはプログラムやデータを主記憶にロードして実行する．
  主記憶の容量は数Giバイト〜数十Giバイト程度であり，
  オペレーティングシステムと全てアプリケーションを格納すには小さすぎる．
\item \emph{二次記憶装置}は，
  近年では，ハードディスクやSSD（Solid State Drive）のことである．
  容量は大きいが，主記憶と比べるとアクセス時間がとても遅い\footnote{
    ハードディスクの場合だと数ミリ秒〜数十ミリ秒もかかる．}．
  しかし，２次記憶装置には電源を切ってもデータが消えない特性がある\footnote{
    ハードディスクなら磁気的に記録しているので消えない．
    SSDならフラッシュメモリに記録しているので消えない．}．
  この特性は\emph{不揮発性}と呼ばれる．
\end{enumerate}

\begin{myfig}{btp}{記憶の階層}{memoryHierachy}
  \includegraphics[scale=1.6]{Fig/memoryHierarchy.pdf}
\end{myfig}

各記憶装置には以上のような特性があるので，
夫々の特性に合った使い方をする必要がある．
オペレーティングシステム，アプリケーションプログラム，
データの全てを永続的に格納するには，
\emph{大容量で不揮発性の二次記憶装置}が適している．

%==============================================================================
\section{接続方式}
\figref{hardBlockAgain}に示すように，
CPUと主記憶やホストコントローラは，バスによって直接に接続される．
これらは，CPUが直接にアクセスすることができる．
一方で二次記憶装置は，ホストコントローラ配下のバス等に接続される．
CPUはホストコントローラにコマンドを送り，
ホストコントローラが二次記憶装置と通信する．
CPUは，二次記憶装置を直接にアクセスすることができない．

\begin{myfig}{btp}{ハードウエア構成（再掲）}{hardBlockAgain}
  \includegraphics[scale=0.55]{Fig/hardBlock-crop.pdf}
\end{myfig}

USBバスに接続されたメモリスティックやハードディスクは，
PC稼働中に接続・取り外しが可能である．
また，CD-ROMなどの光ディスクも取り外し可能である．
これらは，データ交換用やバックアップ用に都合が良い．

%==============================================================================
\section{記憶媒体}
二次記憶装置は大きくテープ型の装置とディスク型の装置に分類できる．
テープ型装置はデータのバックアップやデータの輸送用に用いられてきたが，
最近では使用されることが少なくなっている．
ハードディスクに代表されるディスク型装置は
最もよく使用される二次記憶装置である．
%オペレーティングシステムはハードディスクにインストールされ，
%コンピュータはハードディスクからオペレーティングシステムを読出して起動する．

\begin{enumerate}
\item \emph{テープ型装置}\\
  \figref{magneticTape}に磁気テープの写真を示す\footnote{
    様々な磁気テープが用いられてきたが最近見かけることが少なくなっている．
    写真は，デジタルデータ記録用の8mm磁気テープである．
    \figref{hardBlockAgain}に磁気テープを示してないのは
    最近見かけなくなったためである．
  }．
  カセットの中に１本の長いテープが巻き取られた状態で入っている．
  データは磁気的にテープに記録される．
  データは先頭から順に（シーケンシャルに）書込むことしかできない．
  読出す場合も先頭から順に読出すことしかできない．

  \emph{シーケンシャルアクセス}しかできないため
  読出すデータの位置まで進むために数分かかることもある．
  しかし，一度，データの転送が始まるとハードディスク並のデータ転送速度になる．
  一般に記録できるデータあたりのメディア（磁気テープ）の値段が安いので，
  滅多に使用することが無いバックアップデータを保存するために用いられてきた．

  \begin{myfig}{btp}{磁気テープ}{magneticTape}
    \includegraphics[scale=0.3]{Fig/magneticTape.jpg}
  \end{myfig}

\item \emph{ディスク型装置} \\
  ディスク型装置の代表はハードディスクである．
  \figref{hardDisk}に蓋を開けた状態のハードディスクの写真を示す\footnote{
    3.5インチのハードディスクの蓋を開けた状態である．
    普通，蓋を開けるとハードディスクは壊れるので，
    写真のハードディスクはこわれている．}．
  写真のハードディスクは４枚の円盤が重ねてあり，
  各円盤の表裏（合計８面）にデータが記録できる．
  データは回転する円盤上に磁気的に記録される．

  ディスク型装置の最大の特長は，
  データブロックのアドレスを指定して途中からでも自由に読み書きできることである．
  このようなアクセスの仕方は\emph{ランダムアクセス}と呼ばれる．
  フロッピーディスク，
  CD-ROM，
  DVD-ROM，
  Blu-Ray Disk 等も円盤にデータを記録する方式なのでディスク型装置である．
  一方で，SSDや，USBメモリ，メモリカードは円盤にデータを記録する方式では無いが，
  ランダムアクセスが可能でハードディスクと同様に扱うことができる．
  そのため，これらもディスク型装置として扱う．

  \begin{myfig}{btp}{ハードディスク}{hardDisk}
    \includegraphics[scale=0.3]{Fig/hardDisk.jpg}
  \end{myfig}

\end{enumerate}

%==============================================================================
\section{ハードディスク}
ハードディスクは，
システムの起動ドライブとして使用される．
システム起動後も，
オペレーティングシステムの追加モジュールや
アプリケーションはハードディスクから読み込まれるし，
仮想記憶システムがバッキングストアとしても使用する．
また，アプリケーションがデータを格納する場合も，
第一にハードディスクが選択される．

このようにハードディスクが最も頻繁に使用されるので，
ハードディスクを上手く管理できるかどうかにより，
オペレーティングシステムの性能や使い勝手は大きく左右される．
そのためファイル管理機構は
ハードディスクを管理することを前提にしている\footnote{
最近は apple の APFS \cite{appleFileSystem}のように，
SSDを重視している場合もある．}．
また，ハードディスク以外のディスク型装置は
ハードディスクと同様に扱えるように作ってある．
そこで，ハードディスクについて少しだけ詳しく解説する．

\subsection{セクタ・トラック・シリンダ}
回転する円盤に同心円の\emph{トラック}を作り磁気的にデータを記録する．
一周のトラックに記録できるデータは大きすぎるので，
トラックを幾つかのブロックに分割する．
このブロック（サイズは512Bか4KiB）のことを\emph{セクタ}と呼ぶ．
データの読み書きはセクタ単位で行われる．
同じ半径のトラックは円盤の面の数だけ存在することになる．
各円盤面に散らばった同じ半径のトラックを集めたものを\emph{シリンダ}と呼ぶ．

PC用のハードディスクが世の中に出てきた最初から
セクタのサイズは512バイトであった．
しかし，ハードディスクの大容量化に伴い2009年頃からセクタサイズを4Kiバイトに
した製品が出回るようになってきた．
最近のオペレーティングシステムは
セクタサイズが512バイト以外でも効率よく働くように改良されている．

\subsection{セクタのアドレッシング}
ハードディスク上の特定のセクタを指定するために，
以下の二つの方式のどちらかが使用される．

\begin{description}
\item[CHS（Cylinder Head Sector）]
  シリンダ番号，トラック番号，セクタ番号の組で１つのセクタを特定できる．
  長い間，ハードディスクの読み書きは，
  これら３つの番号を使用したセクタアドレスを用いて行われてきた．
  PCではトラックをトラックに対応する読み書き\emph{ヘッド}で置換え
  シリンダ（Cylinder），ヘッド（Head），セクタ（Sector）の組で
  セクタアドレスを表現してきた．
  このセクタアドレスの表現方式をC\emph{HS方式}と呼ぶ．
\item[LBA（Logical Block Addressing）]
  本来ハードディスクのセクタアドレスは，
  ハードディスクの物理構造を反映した
  シリンダ番号，トラック番号，セクタ番号の組で表すものである．
  オペレーティングシステムは，
  同一ファイルのデータをなるべく同じシリンダに置くなどして，
  ファイルアクセスの効率化を行っていた．
  しかし，現代のハードディスクはブラックボックスになってしまった．
  ディスクコントローラにハードディスクの構造を問い合わせても嘘の情報が
  返されるようになったのである\footnote{
    ディスクの容量を大きすくるために
    外側トラックのセクタ数を内側トラックより多くするなど，
    従来の考え方では表現できない物理構造になってしまった等の事情がある．}．
  そのため，従来の３次元のアドレッシングは煩雑なだけになってしまった．
  現在では全てのセクタに通し番号（１次元のセクタアドレス）をふり，
  この番号でセクタを指定するアドレッシングが一般的である．
  このアドレッシングを\emph{LBA方式}と呼ぶ．
\end{description}

%==============================================================================
\section{フォーマッティング}
二次記憶装置の使用を開始する前に，
記憶媒体を初期化する必要がある\footnote{
  USBメモリやポータブルハードディスクは
  初期化済みの状態で販売されている場合が多い．
  ほとんどの場合，PCは内蔵ハードディスクを初期化した上で
  オペレーティングシステムをインストールした状態で販売されている．
}．
ハードディスクを例に初期化の手順を以下に示す．

\begin{enumerate}
\item \emph{低レベルのフォーマッティング（物理フォーマッティング）を行う．}\\
  低レベルのフォーマッティングは
  ディスクの表面にトラックを磁気的に描いていく作業である．
  20年以上前の製品ではユーザが行うことが可能であったが，
  最近は製造時に工場で物理フォーマッティングを行いユーザにさせない．
  %  ディスクコントローラに低レベルフォーマッティングのコマンドを送っても
  %  何もしない製品が多い．
\item \emph{必要に応じてディスクをパーティション（区画）に分割する．}\\
  ディスク全体を一つのボリューム\footnote{
    Windowsの用語ではドライブと呼ぶ．
    一つのボリュームが一つのファイルシステムを格納する．
  }として使用しても良いが，
  システム領域とユーザ領域のように分けて使用したい場合や，
  一台のディスクに複数のオペレーティングシステムを
  インストールする場合は分割する必要がある．
  % 分割すると「ユーザデータのみバックアップを取る」等の作業がやりやすくなる．

  \begin{figure}[btp]
    \begin{center}
      \begin{minipage}{0.49\columnwidth}
        \centerline{\includegraphics[scale=1.0]{Fig/hddPartition.pdf}}
        \caption{ハードディスクのパーティション}\label{fig:hddPartition}
      \end{minipage}
      \begin{minipage}{0.49\columnwidth}
        \centerline{\includegraphics[scale=1.0]{Fig/masterBootRecord.pdf}}
        \caption{PCのMBR（合計512バイト）}\label{fig:masterBootRecord}
      \end{minipage}
    \end{center}
  \end{figure}

  \figref{hddPartition}に４つのパーティションに分割したハードディスクの
  内部を示す\footnote{この例はPCでMBR方式を使用した場合のものである．}．
  \emph{MBR（Master Boot Record）}は，
  ハードディスクの最初のセクタ（LBA0）に格納され，
  ブートプログラムとパーティションテーブルを記録する．
  \figref{masterBootRecord}にMBRの内容を簡単に示す．
  パーティションテーブルに各パーティションの位置と大きさ等が記録される．
  シグネチャはハードディスクが初期化済みかどうかを表すデータである．
  この2バイトに\texttt{55H} \texttt{AAH}が書き込まれていれば，
  初期化済みである．
  
  \begin{myfig}{btp}{パーティションテーブルの例}{partitionTable}
    \includegraphics[scale=1.0]{Fig/partitionTable.pdf}
  \end{myfig}

  パーティションテーブルの例を\figref{partitionTable}に示す．
  この例は，最初に２つパーティションが存在し（\texttt{Flag=80H}），
  残りのエントリは使用されていない（\texttt{Flag=00H}）場合を示している．
  図中の\texttt{???}等はフラグによって無効にされたエントリの内容か，
  CHSで表現した値が格納される部分である．
  CHS表現は煩雑になるので省略した．

  パティションテーブルエントリの内容は
  \tabref{partitionTableEntry}の通りである．
  一つのエントリは16バイトの大きさになる．
  \|Type|フィールドの意味は\tabref{partitionTableType}の通りである．
  ここに示したものは一部である\footnote{
    詳しくは''Partition type''，
    \url{https://en.wikipedia.org/wiki/Partition_type}等を参照のこと．}．

  \begin{table}[btp]
    \begin{center}
      \begin{minipage}{0.64\columnwidth}
        \caption{パーティションテーブルのエントリ}
        \label{tab:partitionTableEntry}
        \centerline{\includegraphics[scale=1.0]{Tbl/partitionTableEntry.pdf}}
      \end{minipage}
      \begin{minipage}{0.34\columnwidth}
        \caption{Typeフィールドの意味}
        \label{tab:partitionTableType}
        \centerline{\includegraphics[scale=1.0]{Tbl/partitionTableType.pdf}}
      \end{minipage}
    \end{center}
  \end{table}

\item \emph{論理フォーマッティングを行う．}\\
  論理フォーマッティングは，
  ボリューム（パーティション）に空の状態のファイルシステムを作る作業である．
  空のファイルシステムを表現する管理データをディスクに書込む．
\end{enumerate}

\section{ブートストラップ}
オペレーティングシステムは，
コンピュータに内蔵されたハードディスクにインストールされる．
オペレーティングシステムを起動するためには，
ハードディスクからオペレーティングシステムを主記憶にロードし，
実行を開始する必要がある．
この作業をブートストラップ（略してブート）と呼ぶ．

多くの場合オペレーティングシステム本体（カーネル）は，
ファイルシステム上にファイルとして格納されている．
つまり，これから起動するオペレーティングシステムの
ファイルシステムの構造を解釈し，
カーネルファイルを見つけ出す必要がある．
しかし，どのオペレーティングシステムが
インストールされるかはPC製造時には分からない．
そのため，予めPCにオペレーティングシステムのファイルシステムを
解釈する機能を組込むことはできない．
そこで次のように，
いくつかの段階を経てオペレーティングシステムを起動する方式を用いる．
\figref{bootstrapSequence}にブート手順を模式的に表す．

\begin{myfig}{btp}{ハードディスクからのOSのブート手順}{bootstrapSequence}
  \includegraphics[scale=0.66]{Fig/bootstrapSequence-crop.pdf}
\end{myfig}

\begin{enumerate}
\item \emph{IPL（Initial Program Loader）} \\
  PC本体のROMにIPL呼ばれるプログラムが格納されている．
  PCの電源が投入されるとIPLが自動的に実行を開始する．
  IPLはシステム用ハードディスクの最初のセクタ（LBA0）を
  主記憶にロードしそれをプログラムと見做し実行する．
\item \emph{ブートローダ（第１段階）} \\
  LBA0に次段階のブートプログラムが書き込んである．
  これをブートローダ（Loader1）と呼ぶ．
  従来１セクタのサイズは512バイトであったので，
  小さなLoader1でファイルシステムを解釈し
  カーネルをロードすることはできない．
  そこでLoader1は，ハードディスクの\emph{どこか}連続セクタに格納された，
  第２段階の高機能なブートローダ（Loader2）をロードし制御を移す．
\item \emph{ブートローダ（第２段階）} \\
  第２段階のブートローダ（Loader2）が
  ファイルシステムを解釈しカーネルファイルを探し出し，
  カーネルをロード・実行する．
  Loader1，Loader2はオペレーティングシステム毎に異なるので，
  オペレーティングシステムと同時にインストールされる．
\item  \emph{ブートセレクタ（ブートマネージャ）} \\
  ハードディスクがパーティションに分割されている場合は，
  \figref{bootstrapSequenceMulti}に示すように
  LBA0（MBR）に\emph{ブートセレクタ}（ここではBootと呼ぶ）が格納される．
  BootはMBRにパーティションテーブル等と同時に
  格納されるので446バイト以内でなければならない．
  Bootはパーティションの一つを選択し\footnote{
    メニューを表示し，ユーザにキーボードから選択させるなどの方法を使う．}
  パーティションの先頭にインストールされているLoader1相当の
  プログラムをロードし制御を移す．
  \begin{myfig}{btp}
    {複数パーティションを格納するハードディスクからのOSブート手順}
    {bootstrapSequenceMulti}
    \includegraphics[scale=0.66]{Fig/bootstrapSequenceMulti-crop.pdf}
  \end{myfig}
\end{enumerate}

以上がブートストラップの原理である．
ブートローダもハードディスクにインストールされるので，
同じPCで様々なオペレーティングシステムをブートすることができる．
実際は，Loader2が更に高機能なローダを読込む場合もあり，
色々なアレンジメントがあり得る\footnote{
  高機能なローダはファイルシステムに格納され，
  自身の設定ファイルをファイルシステム内に持つような場合もある．}．
しかし，原理的には上の方式でオペレーティングシステムのブートが可能である．

%==============================================================================
\section{実装例}
TacOSに，ディスク型装置をアクセスするデバイスドライバと，
パーティションテーブルを解析するプログラムが含まれる．
TacOSはLBA方式でハードディスク代替のマイクロSDカードをアクセスする．
\ref{tacosLbaDriver}では，
TacOSのマイクロSDカードのデバイスドライバを紹介している．
リスト\ref{tacosMmcspi}がデバイスドライバのソースプログラムである．
パーティションテーブルを解析して
目的のパーティションの位置を調べるプログラムの例は，
\ref{readBlkFile}のリスト\ref{tacosReadMBR}に掲載している．

%==============================================================================
\section{まとめ}
この章では，二次記憶装置について学んだ．
二次記憶装置の特徴は，\emph{大容量}，
\emph{不揮発性}，\emph{低速}なことである．
二次記憶装置は，大きく\emph{テープ型装置}と\emph{ディスク型装置}に分類される．
テープ型装置は\emph{シーケンシャルアクセス}しかできないが，
ディスク型装置は\emph{ランダムアクセス}が可能である．
本書では，メモリカード等の本来はディスク型ではない装置も，
ランダムアクセス可能なものはディスク型装置と呼ぶことにした．

\emph{ハードディスク}は，
ディスク型装置の代表的なものである．
ファイルシステムの多くは，
ハードディスクを上手く管理することを目的としている．
そこで，ハードディスクの構造について少しだけ詳しく学んだ．
セクタのアドレッシングには，
ハードディスクの物理構造と関係の無い\emph{LBA方式}と，
物理構造を意識した\emph{CHS方式}があった．

ハードディスク全体を一つの\emph{ボリューム}としてしてもよいが，
\emph{パーティション（区画）}に分割し夫々をボリュームとして扱うこともできる．
ディスクの先頭セクタ\emph{MBR}に格納されたパーティションテーブルから，
パーティションの位置，大きさ，タイプを知ることができる．

PCの製造時には，どのオペレーティングシステムがインストールされるか分からない．
オペレーティングシステムのブート手順は，
オペレーティングシステムがインストールされるまで分からない．
そこで，PCのROMに格納される\emph{IPL}は，
ハードディスクの先頭セクタを読み出し，
そこに含まれるプログラム（ブートローダ）に
制御を移す機能しか持たないものとする．
ブートローダはオペレーティングシステムのインストール時に書き込まれ，
オペレーティングシステム固有のブート手順を知っている．

%==============================================================================
\section*{練習問題}
\begin{enumerate}
  \renewcommand{\labelenumi}{\ttfamily\arabic{chapter}.\arabic{enumi}}
  \setlength{\leftskip}{1em}
\item 次の言葉の意味を説明しなさい．
  \begin{enumerate}
  \item 二次記憶装置
  \item 揮発性・不揮発性
  \item 記憶の階層
  \item テープ型装置・ディスク型装置
  \item シーケンシャルアクセス・ランダムアクセス
  \item セクタ・トラック・シリンダ
  \item CHS・LBA
  \item ボリューム
  \item パーティション
  \item MBR
  \item IPL
  \item ブートストラップ
  \end{enumerate}
\item 次のディスクに付いて答えなさい．
  \begin{quote}
    \begin{tabular}{l l}
      1台全体   & 1,024シリンダ  \\
      1シリンダ & 8トラック      \\
      1トラック & 128セクタ      \\
      1セクタ   & 512バイト
    \end{tabular}
  \end{quote}
  \begin{enumerate}
  \item ディスクの容量をセクタ単位で答えなさい．
  \item ディスクの容量をバイト単位で答えなさい．
  \item 最後のセクタのアドレスをLBAで答えなさい．
  \item 最後のセクタのアドレスをCHSで答えなさい．\\
    （但し，C：0以上，H：0以上，S：1以上である．）
  \end{enumerate}
\item \figref{partitionTable}に付いて答えなさい．
  \begin{enumerate}
  \item 第1パーティションの位置をLBAで答えなさい．
  \item 第1パーティションのサイズをセクタ数で答えなさい．
  \item 第1パーティションの種類を
    \tabref{partitionTableType}を参照して答えなさい．
  \item 第2パーティションの位置をLBAで答えなさい．
  \item 第2パーティションのサイズをセクタ数で答えなさい．
  \item 第2パーティションの種類を
    \tabref{partitionTableType}を参照して答えなさい．
  \end{enumerate}
\item PC用の高機能なブートローダGRUBについて調査しなさい．
\end{enumerate}
